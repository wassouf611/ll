<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ø®Ø²Ù†Ø© Ø£Ø³Ø±Ø§Ø±ÙŠ</title>
    
    <script src="https://accounts.google.com/gsi/client" onload="initGoogleLib()" async defer></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #8b5cf6; --primary-dark: #7c3aed; --bg: #fdfdfd;
            --surface: #ffffff; --text: #374151; --gray-border: #e5e7eb; --danger: #ef4444;
            --header-height: 70px;
        }
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Tajawal', sans-serif; background-color: var(--bg); margin: 0; padding: 0;
            color: var(--text); height: 100vh; display: flex; flex-direction: column;
            padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom);
        }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ù‚ÙÙ„ */
        #loginOverlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg); z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center;
        }
        .login-card { background: white; padding: 40px 30px; border-radius: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); width: 100%; max-width: 350px; }
        .google-login-btn {
            background: #4285F4; color: white; border: none; padding: 15px; border-radius: 12px; font-size: 16px; font-weight: bold;
            display: flex; align-items: center; justify-content: center; gap: 10px; cursor: pointer; width: 100%; margin-top: 20px;
            box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);
        }

        /* Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¹Ø§Ù… */
        header { height: var(--header-height); padding: 0 20px; display: grid; grid-template-columns: 45px 1fr 45px; align-items: center; position: relative; margin-bottom: 20px; }
        h1 { margin: 0; font-size: 20px; color: var(--primary-dark); font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 8px; white-space: nowrap; }
        .menu-btn { width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; border-radius: 50%; cursor: pointer; background: #f3f4f6; color: #4b5563; transition: 0.2s; }
        .menu-btn:active { background: #e5e7eb; }

        .main-menu {
            position: absolute; top: calc(var(--header-height) + 5px); left: 20px; background: white; border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 260px; display: none; flex-direction: column; overflow: hidden; z-index: 1000; border: 1px solid #f3f4f6;
        }
        .menu-item { padding: 16px 20px; cursor: pointer; border-bottom: 1px solid #f3f4f6; font-size: 15px; font-weight: 500; display: flex; align-items: center; justify-content: space-between; color: #4b5563; }
        .menu-item:last-child { border-bottom: none; }
        .menu-item:active { background: #f9fafb; }
        .menu-icon { width: 20px; height: 20px; opacity: 0.6; }
        .delete-item { color: var(--danger); }
        .delete-item .menu-icon { opacity: 1; color: var(--danger); stroke: var(--danger); }
        .sync-item { background: #f8fafc; }

        .container { padding: 0 25px; flex: 1; display: flex; flex-direction: column; gap: 15px; max-width: 500px; margin: 0 auto; width: 100%; }
        input { width: 100%; padding: 18px; border: 1px solid var(--gray-border); border-radius: 12px; font-family: 'Tajawal'; font-size: 16px; outline: none; background: var(--surface); color: var(--text); }
        input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1); }

        .btn { width: 100%; padding: 16px; border: none; border-radius: 14px; font-size: 16px; font-weight: 700; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .btn-primary { background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; }
        .btn-outline { background: white; color: var(--primary); border: 2px solid var(--primary); box-shadow: none; margin-top: 5px; }
        
        #vaultPage { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f9fafb; z-index: 200; display: none; flex-direction: column; overflow: hidden; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); }
        .vault-fixed-top { padding: 10px 20px 5px 20px; background: #f9fafb; flex-shrink: 0; display: flex; flex-direction: column; gap: 10px; z-index: 10; }
        #vaultList { flex: 1; overflow-y: auto; padding: 10px 20px 100px 20px; }
        
        .account-card { background: white; padding: 15px; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); margin-bottom: 15px; display: flex; align-items: center; gap: 10px; position: relative; overflow: hidden; }
        .account-card::after { content: ''; position: absolute; right: 0; top: 15%; bottom: 15%; width: 4px; background: var(--primary); border-radius: 4px 0 0 4px; }
        .card-main { flex: 1; display: flex; flex-direction: column; gap: 8px; padding-right: 10px; }
        .card-email { font-weight: 700; color: #1f2937; font-size: 15px; display: flex; align-items: center; justify-content: flex-end; gap: 8px; word-break: break-all; }
        .card-pass-pill { background: #f3f4f6; padding: 8px; border-radius: 50px; text-align: center; font-family: monospace; color: #374151; cursor: pointer; letter-spacing: 2px; font-size: 20px; }
        .hidden-pass { color: #9ca3af; letter-spacing: 4px; font-size: 24px; line-height: 0.8; }

        .folders-bar { display: flex; gap: 10px; overflow-x: auto; padding: 5px 2px 10px 2px; scrollbar-width: none; flex-shrink: 0; }
        .folder-chip { background: white; padding: 8px 16px; border-radius: 20px; font-size: 14px; color: #6b7280; border: 1px solid #e5e7eb; white-space: nowrap; cursor: pointer; }
        .folder-chip.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 10px rgba(139, 92, 246, 0.3); }

        .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(2px); z-index: 900; display: none; justify-content: center; align-items: center; padding: 20px; }
        .modal { background: white; width: 100%; max-width: 320px; border-radius: 24px; padding: 25px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.15); animation: popIn 0.3s; }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-actions { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        .btn-small { padding: 12px 20px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; flex: 1; }
        .btn-confirm { background: var(--primary); color: white; }
        .btn-cancel { background: #f3f4f6; color: #374151; }

        .toast { position: fixed; bottom: 50px; left: 50%; transform: translateX(-50%); background: #1f2937; color: white; padding: 12px 25px; border-radius: 30px; font-size: 14px; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 3000; width: max-content; max-width: 90%; text-align: center; }
        .backup-area { width: 100%; height: 100px; border: 1px solid #e5e7eb; border-radius: 12px; padding: 10px; resize: none; background: #f9fafb; outline: none; }
        
        .sync-loader { width: 15px; height: 15px; border: 2px solid #eee; border-top: 2px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; display: none; margin-right: 10px;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body oncontextmenu="return false;">

<!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div id="loginOverlay">
    <div class="login-card">
        <div style="font-size: 40px; margin-bottom: 10px;">ğŸ”</div>
        <h2 style="color:var(--primary); margin:0 0 10px 0">Ø®Ø²Ù†Ø© Ø£Ø³Ø±Ø§Ø±ÙŠ</h2>
        <p style="color: #6b7280; font-size: 14px; line-height: 1.6;">Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ø¨Ø­Ø³Ø§Ø¨ Ø¬ÙˆØ¬Ù„ Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø© ÙˆØ¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø¶ÙŠØ§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p>
        <button id="gLoginBtn" class="google-login-btn" onclick="startGoogleLogin()">
            ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        </button>
        <div id="loginStatus" style="margin-top: 15px; font-size: 13px; color: var(--primary); display:none;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³Ø­Ø§Ø¨Ø©...</div>
    </div>
</div>

<!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
<header>
    <div class="menu-btn" onclick="safeToggleMenu(event)">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>
    </div>
    
    <h1>Ø®Ø²Ù†Ø© Ø£Ø³Ø±Ø§Ø±ÙŠ <div id="syncLoader" class="sync-loader"></div></h1>
    <div style="width: 45px;"></div>
    
    <div id="mainMenu" class="main-menu" onclick="event.stopPropagation()">
        <div class="menu-item sync-item" onclick="forceUploadToDrive()">
            <span>ØªØµØ¯ÙŠØ± Ø³Ø­Ø§Ø¨ÙŠ (Ø±ÙØ¹)</span>
            <svg class="menu-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"></path><path d="M12 12v9"></path><path d="M16 16l-4-4-4 4"></path></svg>
        </div>
        <div class="menu-item sync-item" onclick="forceSyncFromCloud()">
            <span>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø³Ø­Ø§Ø¨ÙŠ (Ø¬Ù„Ø¨)</span>
            <svg class="menu-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"></path><path d="M12 12v9"></path><path d="M8 17l4 4 4-4"></path></svg>
        </div>
        <div class="menu-item" id="menuSetPass" onclick="handleAppLockSettings()">
            <span>ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù„Ù„ØªØ·Ø¨ÙŠÙ‚</span>
            <svg class="menu-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
        </div>
        <div class="menu-item" onclick="showBackupModal()">
            <span>Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ (Ù†ØµÙŠ)</span>
            <svg class="menu-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path></svg>
        </div>
        <div class="menu-item" onclick="showImportModal()">
            <span>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª (Ù†ØµÙŠ)</span>
            <svg class="menu-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path></svg>
        </div>
        <div class="menu-item delete-item" onclick="confirmDeleteAll()">
            <span>Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
            <svg class="menu-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
        </div>
        <div class="menu-item delete-item" onclick="handleLogout()" style="border-top:1px solid #eee;">
            <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
            <svg class="menu-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline></svg>
        </div>
    </div>
</header>

<div class="container">
    <div style="margin-top: 10px;"></div>
    <input type="text" id="emailInput" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ / Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" autocomplete="off">
    <input type="text" id="passInput" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" autocomplete="off">
    <button class="btn btn-primary" onclick="prepareSaveAccount()"><span>Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø®Ø²Ù†Ø©</span></button>
    <button id="vaultBtn" class="btn btn-outline" onclick="openVaultCheck()"><span>ÙØªØ­ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø§Øª</span></button>
</div>

<!-- Vault Page -->
<div id="vaultPage">
    <div class="vault-fixed-top">
        <div class="vault-header">
            <h2 class="vault-title">Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø§Øª ğŸ“‚</h2>
            <button class="icon-btn back-btn" onclick="goBack()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 19 12 12 5"></polyline></svg>
            </button>
        </div>
        <input type="text" id="searchInput" style="width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #e5e7eb; margin-bottom: 10px;" placeholder="Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹..." oninput="renderVault()">
        <div class="folders-bar" id="foldersBar">
            <div class="add-folder-btn" onclick="openAddFolderModal()">+</div>
        </div>
    </div>
    <div id="vaultList"></div>
</div>

<!-- Modals -->
<div id="confirmModal" class="overlay"><div class="modal"><h3 id="confirmTitle">ØªÙ†Ø¨ÙŠÙ‡</h3><p id="confirmMessage">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ</p><div class="modal-actions"><button class="btn-small btn-cancel" onclick="goBack()">Ø¥Ù„ØºØ§Ø¡</button><button class="btn-small btn-confirm" id="confirmYesBtn">Ù†Ø¹Ù…</button></div></div></div>
<div id="passwordModal" class="overlay"><div class="modal"><h3 id="passModalTitle">Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h3><input type="password" id="globalPassInput" style="text-align:center; font-size:24px; letter-spacing:5px; width:100%; border:1px solid #ddd; padding:10px; border-radius:10px;" placeholder="â€¢â€¢â€¢â€¢"><div class="modal-actions"><button class="btn-small btn-cancel" onclick="goBack()">Ø¥Ù„ØºØ§Ø¡</button><button class="btn-small btn-confirm" onclick="submitPassword()">ØªØ£ÙƒÙŠØ¯</button></div></div></div>
<div id="folderSelectModal" class="overlay" onclick="goBack()"><div class="modal" onclick="event.stopPropagation()"><h3 id="folderModalTitle">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¬Ù„Ø¯</h3><div class="folder-list-modal" id="folderListModalBody"></div><div class="modal-actions"><button class="btn-small btn-cancel" onclick="goBack()">Ø¥Ù„ØºØ§Ø¡</button></div></div></div>
<div id="addFolderModal" class="overlay"><div class="modal"><h3>Ù…Ø¬Ù„Ø¯ Ø¬Ø¯ÙŠØ¯</h3><input type="text" id="folderNameInput" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù„Ø¯"><div class="modal-actions"><button class="btn-small btn-cancel" onclick="goBack()">Ø¥Ù„ØºØ§Ø¡</button><button class="btn-small btn-confirm" onclick="submitFolder()">Ø­ÙØ¸</button></div></div></div>
<div id="backupModal" class="overlay" onclick="goBack()"><div class="modal" onclick="event.stopPropagation()"><h3>Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ</h3><textarea id="backupText" class="backup-area" readonly></textarea><div class="modal-actions"><button class="btn-small btn-confirm" onclick="copyBackup()">Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯</button><button class="btn-small btn-cancel" onclick="goBack()">Ø¥ØºÙ„Ø§Ù‚</button></div></div></div>
<div id="importModal" class="overlay" onclick="goBack()"><div class="modal" onclick="event.stopPropagation()"><h3>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</h3><textarea id="importText" class="backup-area" placeholder="Ø§Ù„ØµÙ‚ Ø§Ù„ÙƒÙˆØ¯ Ù‡Ù†Ø§..."></textarea><div class="modal-actions" style="flex-direction:column; gap:10px;"><button class="btn-small btn-cancel" onclick="pasteFromClipboard()" style="width:100%">ğŸ“‹ Ù„ØµÙ‚</button><div style="display:flex; gap:10px; width:100%"><button class="btn-small btn-confirm" onclick="performImport()">Ø§Ø³ØªØ¹Ø§Ø¯Ø©</button><button class="btn-small btn-cancel" onclick="goBack()">Ø¥Ù„ØºØ§Ø¡</button></div></div></div></div>

<div id="toast" class="toast"></div>

<script>
    // --- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
    let accounts = JSON.parse(localStorage.getItem('myPasswords') || '[]');
    let folders = JSON.parse(localStorage.getItem('myFolders') || '["Ø¹Ø§Ù…", "ÙÙŠØ³Ø¨ÙˆÙƒ", "Ø¬ÙˆØ¬Ù„"]');
    accounts.forEach(acc => { if(!acc.folder) acc.folder = 'Ø¹Ø§Ù…'; });
    
    let activeFolder = 'All';
    let pendingCallback = null;

    // --- Google Sync Config ---
    const GOOGLE_CLIENT_ID = '979816526016-ukb9vqtb6u2hlutombpf8rumbjr3o2ua.apps.googleusercontent.com';
    const SCOPES = 'https://www.googleapis.com/auth/drive.appdata';
    const FILENAME = 'secret_vault_v5.json'; 
    let tokenClient, gAccessToken = localStorage.getItem('gAccessToken');

    /* --- Ø§Ù„ØªÙ‡ÙŠØ¦Ø© --- */
    function initGoogleLib() {
        if(window.google) {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID,
                scope: SCOPES,
                callback: (resp) => {
                    if (resp.access_token) {
                        gAccessToken = resp.access_token;
                        localStorage.setItem('gAccessToken', gAccessToken);
                        document.getElementById('loginOverlay').style.display = 'none';
                        showToast("ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„ âœ…");
                        syncFromCloud(true);
                    }
                }
            });
            if(gAccessToken) {
                document.getElementById('loginOverlay').style.display = 'none';
                syncFromCloud(true);
            }
        }
    }

    function startGoogleLogin() {
        document.getElementById('loginStatus').style.display = 'block';
        if(tokenClient) tokenClient.requestAccessToken();
    }

    function handleLogout() {
        if(confirm("ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) {
            localStorage.removeItem('gAccessToken');
            location.reload();
        }
    }

    /* --- Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© --- */
    async function syncFromCloud(silent = false) {
        if(!gAccessToken) return;
        setSyncLoader(true);
        if(!silent) showToast("Ù…Ø²Ø§Ù…Ù†Ø©...");
        try {
            const q = `name = '${FILENAME}' and 'appDataFolder' in parents and trashed = false`;
            const search = await fetch(`https://www.googleapis.com/drive/v3/files?q=${q}&spaces=appDataFolder`, {
                headers: { 'Authorization': `Bearer ${gAccessToken}` }
            });
            if(search.status === 401) { localStorage.removeItem('gAccessToken'); location.reload(); return; }
            const data = await search.json();
            
            if (data.files && data.files.length > 0) {
                // Ø­Ø°Ù Ø§Ù„ØªÙƒØ±Ø§Ø±
                if(data.files.length > 1) {
                    for(let i=1; i<data.files.length; i++) await deleteFile(data.files[i].id);
                }
                const fileId = data.files[0].id;
                const fileResp = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                    headers: { 'Authorization': `Bearer ${gAccessToken}` }
                });
                const cloudContent = await fileResp.json();
                
                if(cloudContent && cloudContent.accounts) {
                    // Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    const localIds = new Set(accounts.map(a => a.id));
                    cloudContent.accounts.forEach(acc => {
                        if(!localIds.has(acc.id)) accounts.push(acc);
                    });
                    folders = [...new Set([...folders, ...(cloudContent.folders || [])])];
                    saveToLocal();
                }
            }
        } catch(e) { console.error(e); }
        setSyncLoader(false);
    }

    async function uploadToDrive() {
        if(!gAccessToken) return;
        setSyncLoader(true);
        const fileContent = JSON.stringify({ accounts, folders });
        const file = new Blob([fileContent], { type: 'application/json' });
        const metadata = { name: FILENAME, mimeType: 'application/json', parents: ['appDataFolder'] };

        try {
            const q = `name = '${FILENAME}' and 'appDataFolder' in parents and trashed = false`;
            const search = await fetch(`https://www.googleapis.com/drive/v3/files?q=${q}&spaces=appDataFolder`, {
                headers: { 'Authorization': `Bearer ${gAccessToken}` }
            });
            const data = await search.json();

            if (data.files && data.files.length > 0) {
                const fileId = data.files[0].id;
                await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${gAccessToken}` },
                    body: createFormData(metadata, file)
                });
            } else {
                await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${gAccessToken}` },
                    body: createFormData(metadata, file)
                });
            }
        } catch(e) { console.error(e); }
        setSyncLoader(false);
    }

    function createFormData(metadata, file) {
        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
        form.append('file', file);
        return form;
    }

    async function deleteFile(id) {
        await fetch(`https://www.googleapis.com/drive/v3/files/${id}`, {
            method: 'DELETE', headers: { 'Authorization': `Bearer ${gAccessToken}` }
        });
    }

    /* --- Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© --- */
    function saveToLocal() {
        localStorage.setItem('myPasswords', JSON.stringify(accounts));
        localStorage.setItem('myFolders', JSON.stringify(folders));
    }

    function prepareSaveAccount() {
        if (!document.getElementById('emailInput').value) { showToast("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ© âš ï¸"); return; }
        openFolderSelectModal("Ø£ÙŠÙ† ØªØ±ÙŠØ¯ Ø­ÙØ¸ Ø§Ù„Ø­Ø³Ø§Ø¨ØŸ");
    }

    function saveAccount(targetFolder) {
        const email = document.getElementById('emailInput').value;
        const pass = document.getElementById('passInput').value;
        accounts.unshift({ id: Date.now(), email, pass, folder: targetFolder });
        saveToLocal();
        uploadToDrive();
        
        document.getElementById('emailInput').value = '';
        document.getElementById('passInput').value = '';
        showToast("ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…");
        renderVault();
    }

    function renderVault() {
        const list = document.getElementById('vaultList');
        const search = document.getElementById('searchInput').value.toLowerCase();
        list.innerHTML = '';
        
        let filtered = accounts;
        if (activeFolder !== 'All') filtered = filtered.filter(a => a.folder === activeFolder);
        if (search) filtered = filtered.filter(a => (a.email && a.email.toLowerCase().includes(search)) || (a.pass && a.pass.toLowerCase().includes(search)));

        if(filtered.length === 0) { list.innerHTML = '<p style="text-align:center;color:#ccc;margin-top:20px">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>'; return; }

        filtered.forEach(acc => {
            const card = document.createElement('div');
            card.className = 'account-card';
            // Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Undefined: Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const emailText = acc.email ? acc.email : (acc.title ? acc.title : 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†');
            const passText = acc.pass ? acc.pass : '...';
            
            card.innerHTML = `
                <div class="card-main">
                    <div class="card-email" onclick="copyText('${emailText}')">
                        <span>${emailText}</span>
                    </div>
                    <div class="card-pass-pill hidden-pass" onclick="togglePass(this, '${passText}')">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</div>
                </div>
                <div style="color:var(--danger); padding:10px;" onclick="deleteItem(${acc.id})">âœ•</div>
            `;
            list.appendChild(card);
        });
    }

    function togglePass(el, pass) {
        if (el.classList.contains('hidden-pass')) {
            el.innerText = pass; el.classList.remove('hidden-pass');
            el.style.fontSize = "16px"; el.style.letterSpacing = "0";
        } else {
            el.innerText = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢'; el.classList.add('hidden-pass');
            el.style.fontSize = "20px"; el.style.letterSpacing = "2px";
        }
    }

    function deleteItem(id) {
        if(confirm("Ø­Ø°ÙØŸ")) {
            accounts = accounts.filter(a => a.id !== id);
            saveToLocal();
            uploadToDrive();
            renderVault();
        }
    }

    /* --- Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙˆØ§Ù„Ù…ÙˆØ¯Ø§Ù„Ø² --- */
    function safeToggleMenu(e) {
        e.stopPropagation();
        const m = document.getElementById('mainMenu');
        const appPass = localStorage.getItem('appPass');
        
        if (m.style.display === 'flex') {
            m.style.display = 'none';
        } else {
            if (appPass) {
                openPasswordModal("Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…Ù‚ÙÙ„Ø©", (val) => {
                    if (val === appPass) m.style.display = 'flex';
                    else showToast("Ø®Ø·Ø£ âŒ");
                });
            } else {
                m.style.display = 'flex';
            }
        }
    }

    function handleAppLockSettings() {
        document.getElementById('mainMenu').style.display = 'none';
        const appPass = localStorage.getItem('appPass');
        if(appPass) {
            openPasswordModal("Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù‚ÙÙ„", (val) => {
                if(val === appPass) { localStorage.removeItem('appPass'); showToast("ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡ ğŸ”“"); updateMenuLabels(); }
                else showToast("Ø®Ø·Ø£");
            });
        } else {
            openPasswordModal("ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±", (val) => {
                if(val) { localStorage.setItem('appPass', val); showToast("ØªÙ… Ø§Ù„Ù‚ÙÙ„ ğŸ”’"); updateMenuLabels(); }
            });
        }
    }

    function confirmDeleteAll() {
        document.getElementById('mainMenu').style.display = 'none';
        customConfirm("Ø­Ø°Ù ÙƒÙ„ Ø´ÙŠØ¡ (Ù…Ø­Ù„ÙŠ ÙˆØ³Ø­Ø§Ø¨ÙŠ)ØŸ", async () => {
            localStorage.clear();
            accounts = [];
            folders = ["Ø¹Ø§Ù…"];
            
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ
            if(gAccessToken) {
                try {
                    const q = `name = '${FILENAME}' and 'appDataFolder' in parents and trashed = false`;
                    const search = await fetch(`https://www.googleapis.com/drive/v3/files?q=${q}&spaces=appDataFolder`, {
                        headers: { 'Authorization': `Bearer ${gAccessToken}` }
                    });
                    const data = await search.json();
                    if(data.files) for(const f of data.files) await deleteFile(f.id);
                } catch(e) {}
            }
            
            showToast("ØªÙ… Ø§Ù„Ø­Ø°Ù Ø§Ù„Ø´Ø§Ù…Ù„ ğŸ‘‹");
            location.reload();
        });
    }

    /* --- Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø°ÙƒÙŠ (Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Undefined) --- */
    function performImport() {
        const val = document.getElementById('importText').value;
        if(!val) return;
        
        try {
            let data = JSON.parse(val);
            let importedAccs = [];
            
            // ØªÙˆØ­ÙŠØ¯ Ø´ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            if(Array.isArray(data)) importedAccs = data;
            else if(data.accounts) importedAccs = data.accounts;
            
            // ØªØµØ­ÙŠØ­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø§Ù‚ØµØ©
            importedAccs = importedAccs.map(acc => {
                // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…ÙØ§ØªÙŠØ­ Ù…Ø®ØªÙ„ÙØ©ØŒ Ù†Ø±Ø¨Ø·Ù‡Ø§
                return {
                    id: acc.id || Date.now() + Math.random(), // ØªÙˆÙ„ÙŠØ¯ ID Ø¬Ø¯ÙŠØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙÙ‚ÙˆØ¯Ø§Ù‹
                    email: acc.email || acc.username || acc.title || 'Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³ØªÙˆØ±Ø¯Ø©',
                    pass: acc.pass || acc.password || '...',
                    folder: acc.folder || 'Ø¹Ø§Ù…'
                };
            });
            
            // Ø¯Ù…Ø¬ Ù…Ø¹ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
            accounts = [...accounts, ...importedAccs];
            saveToLocal();
            uploadToDrive(); // Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØµØ­Ø­Ø© Ù„Ù„Ø³Ø­Ø§Ø¨Ø©
            
            goBack();
            showToast(`ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${importedAccs.length} Ø¹Ù†ØµØ± Ø¨Ù†Ø¬Ø§Ø­ ğŸ‰`);
            renderVault();
            
        } catch(e) {
            console.error(e);
            showToast("ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… âŒ");
        }
    }

    /* --- Helper Functions --- */
    function goBack() { 
        document.querySelectorAll('.overlay').forEach(o => o.style.display = 'none'); 
        document.getElementById('vaultPage').style.display = 'none';
        window.history.back();
    }
    
    function pushHistory() { window.history.pushState({p:'modal'}, null, ''); }
    window.onpopstate = () => { document.querySelectorAll('.overlay').forEach(o => o.style.display = 'none'); document.getElementById('vaultPage').style.display = 'none'; };

    function openPasswordModal(title, cb) {
        pushHistory();
        document.getElementById('passModalTitle').innerText = title;
        document.getElementById('globalPassInput').value = '';
        document.getElementById('passwordModal').style.display = 'flex';
        pendingCallback = cb;
    }
    
    function submitPassword() {
        const val = document.getElementById('globalPassInput').value;
        goBack();
        if(pendingCallback) setTimeout(() => pendingCallback(val), 100);
    }

    function customConfirm(msg, cb) {
        pushHistory();
        document.getElementById('confirmMessage').innerText = msg;
        const btn = document.getElementById('confirmYesBtn');
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        newBtn.onclick = () => { goBack(); setTimeout(cb, 100); };
        document.getElementById('confirmModal').style.display = 'flex';
    }

    function openVaultCheck() {
        const vp = localStorage.getItem('vaultPass');
        if(vp) openPasswordModal("Ø±Ù…Ø² Ø§Ù„Ø®Ø²Ù†Ø©", (v) => { if(v===vp) openVault(); else showToast("Ø®Ø·Ø£"); });
        else openVault();
    }
    
    function openVault() {
        document.getElementById('vaultPage').style.display = 'flex';
        renderFoldersBar();
        renderVault();
    }

    function renderFoldersBar() {
        const bar = document.getElementById('foldersBar');
        bar.innerHTML = `<div class="folder-chip ${activeFolder==='All'?'active':''}" onclick="activeFolder='All'; renderVault(); renderFoldersBar()">Ø§Ù„ÙƒÙ„</div>`;
        folders.forEach(f => {
            bar.innerHTML += `<div class="folder-chip ${activeFolder===f?'active':''}" onclick="activeFolder='${f}'; renderVault(); renderFoldersBar()">${f}</div>`;
        });
        bar.innerHTML += `<div class="add-folder-btn" onclick="openAddFolderModal()">+</div>`;
    }
    
    function openAddFolderModal() {
        pushHistory(); document.getElementById('addFolderModal').style.display = 'flex';
    }
    function submitFolder() {
        const f = document.getElementById('folderNameInput').value;
        if(f) { folders.push(f); saveToLocal(); uploadToDrive(); goBack(); renderFoldersBar(); }
    }
    
    function openFolderSelectModal(title) {
        pushHistory();
        document.getElementById('folderModalTitle').innerText = title;
        const b = document.getElementById('folderListModalBody'); b.innerHTML = '';
        folders.forEach(f => {
            b.innerHTML += `<div class="folder-item-row" onclick="goBack(); setTimeout(()=>saveAccount('${f}'),100)">${f}</div>`;
        });
        document.getElementById('folderSelectModal').style.display = 'flex';
    }
    
    function updateMenuLabels() {
        const span = document.querySelector('#menuSetPass span');
        span.innerText = localStorage.getItem('appPass') ? "Ø¥Ø²Ø§Ù„Ø© Ù‚ÙÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚" : "ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù„Ù„ØªØ·Ø¨ÙŠÙ‚";
    }

    function copyText(txt) { navigator.clipboard.writeText(txt); showToast("ØªÙ… Ø§Ù„Ù†Ø³Ø®"); }
    function pasteFromClipboard() { navigator.clipboard.readText().then(t => document.getElementById('importText').value = t); }
    function forceUploadToDrive() { document.getElementById('mainMenu').style.display='none'; showToast("Ø±ÙØ¹..."); uploadToDrive(); }
    function forceSyncFromCloud() { document.getElementById('mainMenu').style.display='none'; syncFromCloud(); }
    function setSyncLoader(s) { document.getElementById('syncLoader').style.display = s ? 'inline-block' : 'none'; }
    function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.style.opacity='1'; setTimeout(()=>t.style.opacity='0',2000); }

    window.onclick = (e) => { if(!e.target.closest('.menu-btn')) document.getElementById('mainMenu').style.display = 'none'; }
</script>
</body>
</html>