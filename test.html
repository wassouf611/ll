<!DOCTYPE html>  
<html lang="ar" dir="rtl">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">  
    <title>Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ© â˜ï¸</title>  
    
    <!-- Ù…ÙƒØªØ¨Ø© Ø¬ÙˆØ¬Ù„ -->
    <script src="https://accounts.google.com/gsi/client" onload="initGoogleLib()" async defer></script>

    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&family=Amiri:wght@700&display=swap" rel="stylesheet">  
    <style>  
        :root {  
            --bg-color: #f8fafc;  
            --primary-color: #2563eb;  
            --folder-color: #f59e0b; 
            --primary-gradient: linear-gradient(135deg, #2563eb, #1d4ed8);
            --secondary-color: #7c3aed;   
            --success-color: #059669;  
            --danger-color: #dc2626;   
            --card-color: #ffffff;  
            --text-color: #1e293b;  
            --text-secondary: #64748b;  
            --light-bg: #f1f5f9;  
            --border-color: #e2e8f0;   
            --selection-color: #16a34a;  
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);  
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);  
            --radius: 18px;  
            --google-blue: #1a73e8;
        }  

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }  

        body {  
            font-family: 'Tajawal', sans-serif;  
            background-color: var(--bg-color);  
            margin: 0; padding: 20px; color: var(--text-color);  
            padding-bottom: 120px; -webkit-user-select: none; user-select: none;           
        }  
          
        input, textarea { -webkit-user-select: text !important; user-select: text !important; }  

        /* --- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ© (Ø¨Ù…Ø§ Ø£Ù†Ù‡ Ø³Ø­Ø§Ø¨ÙŠ ÙÙ‚Ø·) --- */
        #loginOverlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #f0f2f5; z-index: 6000; 
            display: flex; flex-direction: column; /* Ø¸Ø§Ù‡Ø± Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
            align-items: center; justify-content: center; padding: 20px;
        }
        .login-card {
            background: white; padding: 40px; border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1); text-align: center;
            width: 100%; max-width: 400px;
        }
        .google-btn-auth {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            background-color: var(--google-blue); color: white; border: none;
            padding: 12px; border-radius: 8px; font-size: 16px; font-weight: 700;
            cursor: pointer; width: 100%; margin-top: 20px;
            box-shadow: 0 4px 10px rgba(26, 115, 232, 0.3);
        }

        /* --- Ù…Ø¤Ø´Ø± Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ --- */
        #cloudStatus {
            position: fixed; top: 15px; left: 50%; transform: translateX(-50%);
            background: rgba(30, 41, 59, 0.9); color: white;
            padding: 8px 16px; border-radius: 20px; z-index: 2000;
            font-size: 0.9rem; display: flex; align-items: center; gap: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: top 0.3s;
        }
        #cloudStatus.hidden { top: -60px; }
        .spinner {
            width: 14px; height: 14px; border: 2px solid #fff; border-top-color: transparent;
            border-radius: 50%; animation: spin 1s linear infinite; display: none;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- Ø¨Ù‚ÙŠØ© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª (ÙƒÙ…Ø§ Ù‡ÙŠ) --- */
        .header-content { text-align: center; margin-bottom: 20px; padding-top: 40px; }  
        h1 { color: var(--primary-color); font-weight: 800; font-size: 2.2rem; margin: 0; }  
        
        #navBar { display: none; align-items: center; margin-bottom: 15px; background: white; padding: 10px; border-radius: 12px; box-shadow: var(--shadow-sm); }
        .back-btn { background: var(--light-bg); border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; color: var(--primary-color); font-weight: bold; }
        
        .settings-btn { position: absolute; top: 10px; left: 10px; font-size: 1.8rem; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 50%; }  
        
        .search-container { margin-bottom: 20px; position: relative; }  
        #searchInput { width: 100%; padding: 16px; border-radius: var(--radius); border: none; box-shadow: var(--shadow-md); font-family: 'Tajawal'; text-align: right; font-size: 1.1rem; }  

        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; padding-bottom: 20px; }  
        .note-card { background: white; border-radius: 20px; padding: 15px; height: 160px; display: flex; flex-direction: column; align-items: center; justify-content: space-between; box-shadow: var(--shadow-md); position: relative; border-bottom: 6px solid var(--primary-color); text-align: center; }  
        .note-card.is-folder { background-color: #fffbeb; border-bottom-color: var(--folder-color); }
        .card-title { font-weight: 700; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        
        .fab { position: fixed; bottom: 30px; left: 30px; width: 60px; height: 60px; border-radius: 20px; background: linear-gradient(135deg, var(--secondary-color), #9333ea); color: white; font-size: 2.5rem; border: none; box-shadow: 0 10px 25px rgba(124, 58, 237, 0.4); cursor: pointer; z-index: 1000; }  

        /* Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙˆØ§Ù„Ù†ÙˆØ§ÙØ° */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }  
        .modal-content { background: white; width: 90%; max-width: 350px; padding: 25px; border-radius: 24px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        .full-modal { width: 100%; height: 100%; max-width: none; border-radius: 0; display: flex; flex-direction: column; }
        
        .modal-input-area { width: 100%; flex: 1; padding: 15px; border: 2px solid var(--primary-color); border-radius: 12px; font-family: 'Tajawal'; font-size: 1.2rem; text-align: right; resize: none; margin-bottom: 10px; }
        .modal-input-single { width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 12px; font-family: 'Tajawal'; text-align: right; margin-bottom: 15px; font-size: 1.1rem; }
        
        .modal-btn { flex: 1; padding: 12px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; font-family: 'Tajawal'; }
        .confirm-primary { background: var(--primary-gradient); color: white; }
        .cancel { background: #f1f5f9; color: #64748b; }
        .actions { display: flex; gap: 10px; width: 100%; }

        .sub-notes-list { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 10px 0; }
        .sub-note-item { background: #fff; padding: 15px; margin-bottom: 10px; border-radius: 12px; border-right: 4px solid var(--secondary-color); box-shadow: var(--shadow-sm); cursor: pointer; }

        /* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
        .settings-item { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; cursor: pointer; font-weight: 600; }
        .settings-item:last-child { border: none; }
        
    </style>  
</head>  
<body>  

<!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ© -->
<div id="loginOverlay">
    <div class="login-card">
        <img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg" alt="G" style="width: 60px; margin-bottom: 20px;">
        <h2 style="margin: 0; color: #202124;">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ</h2>
        <p style="color: #5f6368;">Ù‡Ø°Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø³Ø­Ø§Ø¨ÙŠ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„.<br>ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ.</p>
        
        <button class="google-btn-auth" onclick="startGoogleLogin()">
            ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Google
        </button>
        <div id="loginStatus" style="margin-top: 15px; color: var(--primary-color); font-size: 0.9rem;"></div>
    </div>
</div>

<!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ -->
<div id="cloudStatus" class="hidden">
    <div class="spinner" id="cloudSpinner"></div>
    <span id="cloudStatusText">ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«</span>
</div>

<div class="header-content">  
    <span class="settings-btn" onclick="document.getElementById('settingsModal').style.display='flex'">â‹®</span>  
    <h1>Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ© â˜ï¸</h1>  
</div>  

<div id="navBar">
    <button class="back-btn" onclick="goBackFolder()">âœ Ø±Ø¬ÙˆØ¹</button>
    <span id="currentPathTitle" style="margin-right: 10px; font-weight: bold; color: #64748b;"></span>
</div>

<div class="search-container">  
    <input type="text" id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« ÙÙŠ Ø³Ø­Ø§Ø¨ØªÙƒ..." oninput="renderMainGrid(this.value)">  
</div>  

<div id="notesGrid" class="grid-container"></div>  

<button class="fab" onclick="showCreateMenu()">+</button>  

<!-- Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© -->
<div id="createTypeMenu" class="modal" onclick="if(event.target==this) this.style.display='none'">
    <div class="modal-content" style="padding:10px; width: auto; position: absolute; bottom: 100px; left: 30px;">
        <div class="settings-item" onclick="createItemWrapper('folder')">ğŸ“ Ù…Ø¬Ù„Ø¯ Ø¬Ø¯ÙŠØ¯</div>
        <div class="settings-item" onclick="createItemWrapper('note')">ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø© Ø¬Ø¯ÙŠØ¯Ø©</div>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© -->
<div id="detailsModal" class="modal">  
    <div class="modal-content full-modal">  
        <div class="actions" style="margin-bottom: 10px;">
            <button class="back-btn" onclick="closeModalInternal()">âœ Ø±Ø¬ÙˆØ¹</button>
            <span style="margin-right: auto; font-weight: bold; color: var(--primary-color);" id="modalTitle"></span>
        </div>
        <div style="display:flex; gap:5px; margin-bottom:10px;">
            <input type="text" id="newSubNoteInput" placeholder="Ø£Ø¶Ù Ù…Ù„Ø§Ø­Ø¸Ø© Ø¬Ø¯ÙŠØ¯Ø©..." class="modal-input-single" style="margin:0; flex:1;">
            <button onclick="addSubNote()" class="modal-btn confirm-primary" style="flex:0 0 50px;">+</button>
        </div>
        <ul id="subNotesList" class="sub-notes-list"></ul>  
    </div>  
</div>  

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ (ØªØ¹Ø¯ÙŠÙ„/Ø¥Ø¶Ø§ÙØ©) -->
<div id="inputModal" class="modal">  
    <div class="modal-content full-modal">  
        <p id="inputMessage" class="modal-message" style="margin: 10px 0; text-align: center; color: #64748b;"></p>  
        <input type="text" id="modalInputSingle" class="modal-input-single" style="display:none;">
        <textarea id="modalInputArea" class="modal-input-area" style="display:none;"></textarea>
        <div class="actions">  
            <button id="inputBtn" class="modal-btn confirm-primary">Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø© â˜ï¸</button>  
            <button class="modal-btn cancel" onclick="hideInputModal(false)">Ø¥Ù„ØºØ§Ø¡</button>  
        </div>  
    </div>  
</div>  

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª (Ù„Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª) -->
<div id="contextMenu" class="modal" onclick="if(event.target==this) this.style.display='none'">
    <div class="modal-content">
        <div class="settings-item" onclick="handleMenuAction('edit')">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…</div>
        <div class="settings-item" style="color:red" onclick="handleMenuAction('delete')">ğŸ—‘ï¸ Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</div>
        <div class="settings-item" onclick="document.getElementById('contextMenu').style.display='none'">Ø¥Ù„ØºØ§Ø¡</div>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„ÙØ±Ø¹ÙŠØ© -->
<div id="subNoteContextMenu" class="modal" onclick="if(event.target==this) this.style.display='none'">
    <div class="modal-content">
        <div class="settings-item" onclick="handleSubNoteAction('edit')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</div>
        <div class="settings-item" onclick="handleSubNoteAction('copy')">ğŸ“„ Ù†Ø³Ø®</div>
        <div class="settings-item" style="color:red" onclick="handleSubNoteAction('delete')">ğŸ—‘ï¸ Ø­Ø°Ù</div>
    </div>
</div>

<!-- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
<div id="settingsModal" class="modal" onclick="if(event.target==this) this.style.display='none'">
    <div class="modal-content">
        <h3>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>
        <div class="settings-item" onclick="forceSyncFromCloud()">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø¬Ù„Ø¨)</div>
        <div class="settings-item" onclick="handleGoogleLogout()" style="color:red; border-top:1px solid #ddd;">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</div>
        <button class="modal-btn cancel" onclick="document.getElementById('settingsModal').style.display='none'" style="margin-top:10px; width:100%">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<script>  
    // --- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ---
    // Ù„Ù† Ù†Ø³ØªØ®Ø¯Ù… localStorage Ù„Ù„Ù…Ù„Ø§Ø­Ø¸Ø§ØªØŒ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù‡Ù†Ø§ Ù‡ÙŠ "Ø°Ø§ÙƒØ±Ø© Ù…Ø¤Ù‚ØªØ©" ÙÙ‚Ø·
    let allData = [];   
    let currentFolderId = null; 
    let activeCardId = null; 
    let currentNoteId = null; 
    let activeSubNoteIndex = null; 

    // --- Google Config ---
    const GOOGLE_CLIENT_ID = '979816526016-ukb9vqtb6u2hlutombpf8rumbjr3o2ua.apps.googleusercontent.com';
    const SCOPES = 'https://www.googleapis.com/auth/drive.appdata https://www.googleapis.com/auth/userinfo.profile';
    const FILENAME = 'smart_notes_cloud_v1.json'; // Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ Ø§Ù„Ù…ÙˆØ­Ø¯
    let tokenClient;
    let gAccessToken = localStorage.getItem('gAccessToken');

    // --- Ø§Ù„Ø¨Ø¯Ø¡ ---
    function initGoogleLib() {
        if(window.google) {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID, scope: SCOPES,
                callback: (resp) => {
                    if (resp.access_token) {
                        gAccessToken = resp.access_token;
                        localStorage.setItem('gAccessToken', gAccessToken);
                        document.getElementById('loginOverlay').style.display = 'none';
                        forceSyncFromCloud(); // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙˆØ±Ø§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„
                    }
                }
            });

            if(gAccessToken) {
                document.getElementById('loginOverlay').style.display = 'none';
                forceSyncFromCloud(); // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø³Ø§Ø¨Ù‚Ø§Ù‹
            } else {
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ØŒ Ø§Ø¨Ù‚ ÙÙŠ Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
                // tokenClient.requestAccessToken({prompt: 'none'}); // Ù…Ø­Ø§ÙˆÙ„Ø© ØµØ§Ù…ØªØ© Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©
            }
        }
    }

    function startGoogleLogin() {
        document.getElementById('loginStatus').innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¬ÙˆØ¬Ù„...";
        if(tokenClient) tokenClient.requestAccessToken();
    }

    function handleGoogleLogout() {
        if(confirm("ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ Ø³ØªÙÙ‚Ø¯ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø­ØªÙ‰ ØªØ³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹.")) {
            localStorage.removeItem('gAccessToken');
            location.reload(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
        }
    }

    // --- Ø§Ù„Ù…Ø­Ø±Ùƒ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ (Cloud Engine) ---
    
    function updateCloudStatus(status) {
        const el = document.getElementById('cloudStatus');
        const text = document.getElementById('cloudStatusText');
        const spin = document.getElementById('cloudSpinner');
        
        el.classList.remove('hidden');
        
        if (status === 'saving') {
            text.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©...";
            spin.style.display = 'block';
            el.style.background = "rgba(37, 99, 235, 0.9)"; // Ø£Ø²Ø±Ù‚
        } else if (status === 'loading') {
            text.innerText = "Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...";
            spin.style.display = 'block';
            el.style.background = "rgba(37, 99, 235, 0.9)";
        } else if (status === 'success') {
            text.innerText = "ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© âœ…";
            spin.style.display = 'none';
            el.style.background = "rgba(5, 150, 105, 0.9)"; // Ø£Ø®Ø¶Ø±
            setTimeout(() => el.classList.add('hidden'), 2000);
        } else if (status === 'error') {
            text.innerText = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ âŒ";
            spin.style.display = 'none';
            el.style.background = "rgba(220, 38, 38, 0.9)"; // Ø£Ø­Ù…Ø±
            setTimeout(() => el.classList.add('hidden'), 3000);
        }
    }

    // Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù‡ÙŠ "Ø§Ù„Ù‚Ù„Ø¨": Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„ ÙŠØ­ØµÙ„ØŒ Ù†Ø³ØªØ¯Ø¹ÙŠÙ‡Ø§ ÙÙˆØ±Ø§Ù‹ Ù„Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    async function saveToCloud() {
        if(!gAccessToken) return; // Ù„Ø§ Ù†ÙØ¹Ù„ Ø´ÙŠØ¡ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„
        updateCloudStatus('saving');

        try {
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù„Ù
            const q = `name = '${FILENAME}' and 'appDataFolder' in parents and trashed = false`;
            const searchResp = await fetch(`https://www.googleapis.com/drive/v3/files?q=${q}&spaces=appDataFolder`, {
                headers: { 'Authorization': `Bearer ${gAccessToken}` }
            });

            if(searchResp.status === 401) {
                // Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù†ØªÙ‡Ù‰
                localStorage.removeItem('gAccessToken');
                location.reload(); 
                return;
            }

            const data = await searchResp.json();
            let fileId = null;
            if(data.files && data.files.length > 0) fileId = data.files[0].id;

            // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const payload = { smartNotesData: allData };
            const fileBlob = new Blob([JSON.stringify(payload)], { type: 'application/json' });

            if(fileId) {
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
                await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${gAccessToken}`, 'Content-Type': 'application/json' },
                    body: fileBlob
                });
            } else {
                // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯
                const metadata = { name: FILENAME, mimeType: 'application/json', parents: ['appDataFolder'] };
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', fileBlob);
                await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${gAccessToken}` },
                    body: form
                });
            }
            updateCloudStatus('success');
        } catch(e) {
            console.error(e);
            updateCloudStatus('error');
        }
    }

    // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
    async function forceSyncFromCloud() {
        if(!gAccessToken) return;
        updateCloudStatus('loading');
        document.getElementById('settingsModal').style.display='none';

        try {
            const q = `name = '${FILENAME}' and 'appDataFolder' in parents and trashed = false`;
            const searchResp = await fetch(`https://www.googleapis.com/drive/v3/files?q=${q}&spaces=appDataFolder`, {
                headers: { 'Authorization': `Bearer ${gAccessToken}` }
            });
            
            const data = await searchResp.json();
            if(data.files && data.files.length > 0) {
                const fileId = data.files[0].id;
                const fileResp = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                    headers: { 'Authorization': `Bearer ${gAccessToken}` }
                });
                const cloudContent = await fileResp.json();
                
                if(cloudContent.smartNotesData) {
                    allData = cloudContent.smartNotesData;
                    renderMainGrid();
                    // Ø¥Ø°Ø§ ÙƒÙ†Ø§ Ø¯Ø§Ø®Ù„ Ù…Ù„Ø§Ø­Ø¸Ø©ØŒ Ù†Ø­Ø¯Ø« Ø¹Ø±Ø¶Ù‡Ø§ Ø£ÙŠØ¶Ø§Ù‹
                    if(document.getElementById('detailsModal').style.display === 'flex' && currentNoteId) {
                        renderSubNotes();
                    }
                    updateCloudStatus('success');
                } else {
                    updateCloudStatus('success'); // Ù…Ù„Ù ÙØ§Ø±ØºØŒ Ù„Ø§ Ø¨Ø£Ø³
                }
            } else {
                // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù Ø¨Ø¹Ø¯ (Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯)
                updateCloudStatus('success');
            }
        } catch(e) {
            console.error(e);
            updateCloudStatus('error');
        }
    }

    // --- Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ (Ù…Ø¹Ø¯Ù„ Ù„Ù„Ø­ÙØ¸ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ) ---

    function findNoteById(list, id) {
        id = parseInt(id); 
        for (let item of list) {
            if (parseInt(item.id) === id) return item;
            if (item.type === 'folder' && item.items) {
                const found = findNoteById(item.items, id);
                if (found) return found;
            }
        }
        return null;
    }

    function getCurrentList() {
        if (currentFolderId === null) return allData;
        const folder = findNoteById(allData, currentFolderId);
        return folder ? folder.items : [];
    }

    function renderMainGrid(filter = '') {
        const grid = document.getElementById('notesGrid'); grid.innerHTML = '';
        const navBar = document.getElementById('navBar');
        
        if (currentFolderId === null) { navBar.style.display = 'none'; } 
        else { navBar.style.display = 'flex'; const folder = findNoteById(allData, currentFolderId); document.getElementById('currentPathTitle').innerText = folder ? `ğŸ“ ${folder.title}` : ''; }

        const list = getCurrentList(); 
        const filteredList = list.filter(n => n.title.toLowerCase().includes(filter.toLowerCase()));

        filteredList.forEach(item => {
            const card = document.createElement('div'); card.className = `note-card ${item.type === 'folder' ? 'is-folder' : ''}`;
            let icon = item.type === 'folder' ? 'ğŸ“' : 'ğŸ“„';
            const count = item.items.length; const countLabel = item.type === 'folder' ? 'Ø¹Ù†ØµØ±' : 'Ù…Ù„Ø§Ø­Ø¸Ø©';
            
            card.innerHTML = ` <div class="card-icon-big">${icon}</div> <div class="card-title">${item.title}</div> <div class="card-count">${count} ${countLabel}</div> `;
            card.onclick = () => handleCardClick(item); 
            card.oncontextmenu = (e) => { e.preventDefault(); showContextMenu(item.id); };
            
            // Long press for mobile context menu
            let pressTimer;
            card.addEventListener('touchstart', () => { pressTimer = setTimeout(() => showContextMenu(item.id), 600); });
            card.addEventListener('touchend', () => clearTimeout(pressTimer));
            
            grid.appendChild(card);
        });
    }

    function handleCardClick(item) {
        if (item.type === 'folder') {
            currentFolderId = item.id; renderMainGrid();
        } else {
            openNoteDetails(item.id);
        }
    }

    function goBackFolder() {
        if(currentFolderId === null) return;
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø£Ø¨ Ø¨Ø³ÙŠØ· Ù‡Ù†Ø§: Ù†Ø¹ÙˆØ¯ Ù„Ù„Ø¬Ø°Ø±. (Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØµÙØ­ Ø§Ù„Ø¹Ù…ÙŠÙ‚ ÙŠØ­ØªØ§Ø¬ Ù…Ù†Ø·Ù‚ Ø£Ø¹Ù‚Ø¯)
        // ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø¨Ø³ÙŠØ·ØŒ Ø§Ù„Ø±Ø¬ÙˆØ¹ ÙŠØ¹ÙŠØ¯ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø³Ù‡ÙˆÙ„Ø©
        currentFolderId = null; 
        renderMainGrid();
    }

    // --- Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± ---
    function showCreateMenu() { document.getElementById('createTypeMenu').style.display='flex'; }
    
    async function createItemWrapper(type) {
        document.getElementById('createTypeMenu').style.display = 'none';
        const title = await showInputModal(type === 'folder' ? 'Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù„Ø¯:' : 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©:', '', 'single');
        if (title) { 
            const newItem = { id: Date.now(), type, title, items: [] }; 
            getCurrentList().unshift(newItem); 
            renderMainGrid(); 
            
            // ğŸ”¥ Ø­ÙØ¸ Ø³Ø­Ø§Ø¨ÙŠ ÙÙˆØ±ÙŠ ğŸ”¥
            saveToCloud();
            
            if (type === 'note') openNoteDetails(newItem.id); 
        }
    }

    // --- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© ---
    function openNoteDetails(id) {
        currentNoteId = id;
        const note = findNoteById(allData, id); 
        if (!note) return;
        document.getElementById('modalTitle').innerText = note.title;
        document.getElementById('detailsModal').style.display = 'flex';
        renderSubNotes();
    }

    function closeModalInternal() {
        document.getElementById('detailsModal').style.display = 'none';
    }

    function renderSubNotes() {
        const listEl = document.getElementById('subNotesList'); listEl.innerHTML = '';
        const note = findNoteById(allData, currentNoteId); if (!note) return;
        
        note.items.forEach((content, index) => {
            const li = document.createElement('li'); li.className = 'sub-note-item';
            let displayContent = content.length > 100 ? content.substring(0, 100) + '...' : content;
            li.innerHTML = `<div>${displayContent}</div>`;
            li.onclick = () => editSubNote(index);
            
            // Long press for sub-note context
            let pressTimer;
            li.addEventListener('touchstart', () => { pressTimer = setTimeout(() => showSubContextMenu(index), 600); });
            li.addEventListener('touchend', () => clearTimeout(pressTimer));
            
            listEl.appendChild(li);
        });
    }

    function addSubNote() {
        const input = document.getElementById('newSubNoteInput');
        if (input.value.trim() === '') return;
        const note = findNoteById(allData, currentNoteId);
        note.items.unshift(input.value.trim());
        input.value = '';
        
        renderSubNotes();
        // ğŸ”¥ Ø­ÙØ¸ Ø³Ø­Ø§Ø¨ÙŠ ÙÙˆØ±ÙŠ ğŸ”¥
        saveToCloud();
    }

    async function editSubNote(index) {
        const note = findNoteById(allData, currentNoteId);
        const newContent = await showInputModal('', note.items[index], 'area');
        if (newContent !== null) { 
            note.items[index] = newContent; 
            renderSubNotes(); 
            // ğŸ”¥ Ø­ÙØ¸ Ø³Ø­Ø§Ø¨ÙŠ ÙÙˆØ±ÙŠ ğŸ”¥
            saveToCloud();
        }
    }

    // --- Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„ÙØ±Ø¹ÙŠØ© (Ø­Ø°Ù/ØªØ¹Ø¯ÙŠÙ„) ---
    function showContextMenu(id) {
        activeCardId = id;
        document.getElementById('contextMenu').style.display = 'flex';
    }
    
    function showSubContextMenu(index) {
        activeSubNoteIndex = index;
        document.getElementById('subNoteContextMenu').style.display = 'flex';
    }

    async function handleMenuAction(action) {
        document.getElementById('contextMenu').style.display = 'none';
        const item = findNoteById(allData, activeCardId);
        
        if (action === 'delete') {
            if (confirm(`Ø­Ø°Ù "${item.title}" Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©ØŸ`)) {
                if (currentFolderId === null) allData = allData.filter(n => n.id !== activeCardId);
                else findNoteById(allData, currentFolderId).items = findNoteById(allData, currentFolderId).items.filter(n => n.id !== activeCardId);
                renderMainGrid();
                saveToCloud(); // ğŸ”¥
            }
        } else if (action === 'edit') {
            const newTitle = await showInputModal('ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…:', item.title, 'single');
            if (newTitle) { 
                item.title = newTitle; 
                renderMainGrid(); 
                saveToCloud(); // ğŸ”¥
            }
        }
    }

    async function handleSubNoteAction(action) {
        document.getElementById('subNoteContextMenu').style.display = 'none';
        const note = findNoteById(allData, currentNoteId);
        
        if (action === 'delete') {
            note.items.splice(activeSubNoteIndex, 1);
            renderSubNotes();
            saveToCloud(); // ğŸ”¥
        } else if (action === 'copy') {
            navigator.clipboard.writeText(note.items[activeSubNoteIndex]);
            alert("ØªÙ… Ø§Ù„Ù†Ø³Ø®");
        } else if (action === 'edit') {
            editSubNote(activeSubNoteIndex);
        }
    }

    // --- Modal Logic ---
    function showInputModal(msg, val, type) {
        document.getElementById('inputMessage').innerText = msg;
        const modal = document.getElementById('inputModal');
        const single = document.getElementById('modalInputSingle');
        const area = document.getElementById('modalInputArea');
        
        single.style.display = type === 'single' ? 'block' : 'none';
        area.style.display = type === 'area' ? 'block' : 'none';
        
        const input = type === 'single' ? single : area;
        input.value = val;
        
        modal.style.display = 'flex';
        input.focus();

        return new Promise(resolve => {
            document.getElementById('inputBtn').onclick = () => {
                modal.style.display = 'none';
                resolve(input.value);
            };
            window.hideInputModal = () => {
                modal.style.display = 'none';
                resolve(null);
            };
        });
    }

</script>  
</body>  
</html>