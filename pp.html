<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ø®Ø²Ù†Ø© Ø£Ø³Ø±Ø§Ø±ÙŠ Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†Ø©</title>
    
    <script src="https://accounts.google.com/gsi/client" onload="initGoogleLib()" async defer></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #8b5cf6; --primary-dark: #7c3aed; --bg: #fdfdfd;
            --surface: #ffffff; --text: #374151; --gray-border: #e5e7eb; --danger: #ef4444;
        }
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Tajawal', sans-serif; background-color: var(--bg); margin: 0; padding: 0;
            color: var(--text); height: 100vh; display: flex; flex-direction: column;
            padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom);
        }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ù‚ÙÙ„ */
        #loginOverlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: white; z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px;
        }
        .login-card { background: #f8f9fa; padding: 30px; border-radius: 20px; width: 100%; max-width: 350px; text-align: center; }
        .google-btn {
            background: #4285F4; color: white; border: none; padding: 12px; border-radius: 50px;
            font-weight: bold; width: 100%; margin-top: 20px; cursor: pointer; display: flex; justify-content: center; gap: 10px;
        }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
        header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; height: 70px; }
        h1 { margin: 0; font-size: 18px; color: var(--primary-dark); }
        .menu-btn { width: 40px; height: 40px; background: #f3f4f6; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        
        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
        .main-menu {
            position: absolute; top: 75px; left: 20px; background: white; border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1); width: 220px; display: none; flex-direction: column; z-index: 1000; border: 1px solid #eee;
        }
        .menu-item { padding: 15px; border-bottom: 1px solid #f9f9f9; cursor: pointer; display: flex; justify-content: space-between; font-size: 14px; }
        .menu-item.danger { color: var(--danger); }

        /* Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
        .container { padding: 0 25px; flex: 1; display: flex; flex-direction: column; gap: 12px; max-width: 500px; margin: 0 auto; width: 100%; justify-content: center; }
        input { width: 100%; padding: 16px; border: 1px solid #ddd; border-radius: 12px; font-family: 'Tajawal'; font-size: 16px; outline: none; }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 14px; font-weight: bold; cursor: pointer; font-size: 16px; font-family: 'Tajawal'; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: white; border: 2px solid var(--primary); color: var(--primary); }

        /* Ø§Ù„Ø®Ø²Ù†Ø© */
        #vaultPage {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fdfdfd; z-index: 100;
            display: none; flex-direction: column; padding-top: env(safe-area-inset-top);
        }
        .vault-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
        #vaultList { flex: 1; overflow-y: auto; padding: 20px; }
        
        .card {
            background: white; padding: 15px; border-radius: 12px; margin-bottom: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-right: 4px solid var(--primary);
            display: flex; align-items: center; justify-content: space-between;
        }
        .pass-pill { background: #f0f0f0; padding: 5px 12px; border-radius: 20px; font-family: monospace; font-size: 16px; cursor: pointer; }
        
        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: #333; color: white; padding: 10px 20px; border-radius: 20px; font-size: 13px;
            opacity: 0; transition: 0.3s; pointer-events: none; z-index: 5000;
        }
        
        .loading-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.8);
            display: none; align-items: center; justify-content: center; z-index: 10; font-weight: bold; color: var(--primary);
        }
    </style>
</head>
<body>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div id="loginOverlay">
    <div class="login-card">
        <h2>ğŸ”’ Ø®Ø²Ù†Ø© Ø£Ø³Ø±Ø§Ø±ÙŠ</h2>
        <p>ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ ÙˆØ¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø¶ÙŠØ§Ø¹Ù‡Ø§.</p>
        <button class="google-btn" onclick="client.requestAccessToken()">
            ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Google
        </button>
    </div>
</div>

<!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
<header>
    <div class="menu-btn" onclick="toggleMenu(event)">â˜°</div>
    <h1 id="statusText">Ø¬Ø§Ù‡Ø²</h1>
    <div style="width:40px"></div> <!-- Spacer -->
    
    <div id="mainMenu" class="main-menu" onclick="event.stopPropagation()">
        <div class="menu-item danger" onclick="deleteAllCloud()">Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø³Ø­Ø§Ø¨ÙŠØ§Ù‹) ğŸ—‘ï¸</div>
        <div class="menu-item danger" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ğŸ‘‹</div>
    </div>
</header>

<div class="container">
    <div style="position:relative">
        <div id="loader" class="loading-overlay">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...</div>
        <input type="text" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ / Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
        <div style="height:10px"></div>
        <input type="text" id="pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± / Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©">
    </div>

    <button class="btn btn-primary" onclick="saveData()">Ø­ÙØ¸ ÙˆÙ…Ø²Ø§Ù…Ù†Ø© â˜ï¸</button>
    <button class="btn btn-outline" onclick="openVault()">ÙØªØ­ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø§Øª ğŸ“‚</button>
</div>

<!-- ØµÙØ­Ø© Ø§Ù„Ø¹Ø±Ø¶ -->
<div id="vaultPage">
    <div class="vault-header">
        <h2>Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø§Øª</h2>
        <button class="btn btn-outline" style="width:auto; padding:8px 20px;" onclick="closeVault()">Ø±Ø¬ÙˆØ¹</button>
    </div>
    <div id="vaultList"></div>
</div>

<div id="toast" class="toast"></div>

<script>
    /* --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¬ÙˆØ¬Ù„ --- */
    const CLIENT_ID = '979816526016-ukb9vqtb6u2hlutombpf8rumbjr3o2ua.apps.googleusercontent.com';
    const SCOPES = 'https://www.googleapis.com/auth/drive.appdata';
    const FILE_NAME = 'secret_vault_unified_v2.json'; // Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯ Ù„Ø¶Ù…Ø§Ù† Ù…Ù„Ù Ù†Ø¸ÙŠÙ
    
    let client;
    let accessToken = localStorage.getItem('g_token');
    let fileId = localStorage.getItem('g_file_id'); // Ù†Ø­ØªÙØ¸ Ø¨Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ù„Ù Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù„Ù†ÙØ³ Ø§Ù„Ù…Ù„Ù

    let localData = []; // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø§Ù„Ù…Ø¤Ù‚ØªØ©

    function initGoogleLib() {
        client = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID, scope: SCOPES,
            callback: (resp) => {
                if (resp.access_token) {
                    accessToken = resp.access_token;
                    localStorage.setItem('g_token', accessToken);
                    document.getElementById('loginOverlay').style.display = 'none';
                    initialSync(); // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ÙÙˆØ± Ø§Ù„Ø¯Ø®ÙˆÙ„
                }
            }
        });

        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø³Ø¬Ù„Ø§Ù‹ Ø³Ø§Ø¨Ù‚Ø§Ù‹
        if (accessToken) {
            document.getElementById('loginOverlay').style.display = 'none';
            initialSync();
        }
    }

    /* --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØµØ§Ø±Ù… (Fetch -> Merge -> Update) --- */
    
    async function initialSync() {
        showLoader(true);
        setStatus("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³Ø­Ø§Ø¨Ø©...");
        
        try {
            // 1. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù„Ù
            const q = `name = '${FILE_NAME}' and 'appDataFolder' in parents and trashed = false`;
            const search = await fetch(`https://www.googleapis.com/drive/v3/files?q=${q}&spaces=appDataFolder&fields=files(id, name)`, {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });

            if (search.status === 401) { logout(); return; } // Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©

            const data = await search.json();
            
            if (data.files && data.files.length > 0) {
                // ÙˆØ¬Ø¯Ù†Ø§ Ø§Ù„Ù…Ù„ÙØŒ Ù†Ø£Ø®Ø° Ø§Ù„Ø£ÙˆÙ„ ÙˆÙ†Ø¹ØªÙ…Ø¯ Ø¹Ù„ÙŠÙ‡
                fileId = data.files[0].id;
                localStorage.setItem('g_file_id', fileId);
                
                // ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¥Ù† ÙˆØ¬Ø¯
                if (data.files.length > 1) {
                    for (let i = 1; i < data.files.length; i++) {
                        await deleteFileApi(data.files[i].id);
                    }
                }

                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
                await downloadContent(fileId);
            } else {
                // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„ÙØŒ Ù†Ù†Ø´Ø¦ ÙˆØ§Ø­Ø¯Ø§Ù‹ ÙØ§Ø±ØºØ§Ù‹
                await createNewFile();
            }
            setStatus("ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© âœ…");
        } catch (error) {
            console.error(error);
            showToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„");
        }
        showLoader(false);
    }

    async function downloadContent(id) {
        const resp = await fetch(`https://www.googleapis.com/drive/v3/files/${id}?alt=media`, {
            headers: { 'Authorization': `Bearer ${accessToken}` }
        });
        const content = await resp.json();
        if (Array.isArray(content)) {
            localData = content;
        } else {
            localData = []; // Ù…Ù„Ù ØªØ§Ù„Ù Ø£Ùˆ ÙØ§Ø±Øº
        }
        renderVault();
    }

    async function createNewFile() {
        const metadata = { name: FILE_NAME, parents: ['appDataFolder'] };
        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
        form.append('file', new Blob([JSON.stringify([])], { type: 'application/json' }));

        const resp = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${accessToken}` },
            body: form
        });
        const data = await resp.json();
        fileId = data.id;
        localStorage.setItem('g_file_id', fileId);
        localData = [];
    }

    // Ù‡Ø°Ù‡ Ø£Ù‡Ù… Ø¯Ø§Ù„Ø©: ØªÙ‚ÙˆÙ… Ø¨Ø¬Ù„Ø¨ Ø§Ù„Ø­Ø¯ÙŠØ« Ø«Ù… Ø§Ù„Ø¯Ù…Ø¬ Ø«Ù… Ø§Ù„Ø±ÙØ¹
    async function saveData() {
        const email = document.getElementById('email').value;
        const pass = document.getElementById('pass').value;

        if (!email || !pass) { showToast("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹"); return; }
        
        showLoader(true);
        setStatus("Ø¬Ø§Ø±ÙŠ Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ±ÙØ¹Ù‡Ø§...");

        try {
            // 1. Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸ØŒ Ù†Ø¬Ù„Ø¨ Ø¢Ø®Ø± Ù†Ø³Ø®Ø© Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø© (Ù„Ø¶Ù…Ø§Ù† ÙˆØ¬ÙˆØ¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¬ÙˆØ§Ù„ Ø§Ù„Ø«Ø§Ù†ÙŠ)
            if (fileId) {
                const resp = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                if (resp.ok) {
                    const cloudData = await resp.json();
                    if (Array.isArray(cloudData)) localData = cloudData;
                }
            } else {
                // ÙÙŠ Ø­Ø§Ù„ Ø¶ÙŠØ§Ø¹ Ø§Ù„Ù€ IDØŒ Ù†Ø¨Ø­Ø« Ø¹Ù†Ù‡ Ù…Ø¬Ø¯Ø¯Ø§Ù‹
                await initialSync(); 
            }

            // 2. Ù†Ø¶ÙŠÙ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            localData.unshift({ id: Date.now(), email, pass, date: new Date().toLocaleDateString() });

            // 3. Ù†Ø±ÙØ¹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© (ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­ØªÙˆÙ‰)
            const updateUrl = `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`;
            await fetch(updateUrl, {
                method: 'PATCH',
                headers: { 
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(localData)
            });

            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ù‚ÙˆÙ„
            document.getElementById('email').value = '';
            document.getElementById('pass').value = '';
            
            showToast("ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­ âœ…");
            setStatus("ØªÙ… Ø§Ù„Ø­ÙØ¸");
            renderVault();

        } catch (e) {
            console.error(e);
            showToast("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸! ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§Ù†ØªØ±Ù†Øª");
        }
        showLoader(false);
    }

    async function deleteItem(id) {
        if (!confirm("Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ±ØŸ")) return;
        
        showLoader(true);
        // Ø§Ù„Ø­Ø°Ù ÙŠØªØ·Ù„Ø¨ Ø£ÙŠØ¶Ø§Ù‹ Ø¬Ù„Ø¨-Ø­Ø°Ù-Ø±ÙØ¹
        try {
             // 1. Ø¬Ù„Ø¨
             const resp = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            let currentCloudData = await resp.json();
            
            // 2. Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            currentCloudData = currentCloudData.filter(item => item.id !== id);
            localData = currentCloudData;

            // 3. Ø±ÙØ¹
            await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
                method: 'PATCH',
                headers: { 
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(localData)
            });
            
            renderVault();
            showToast("ØªÙ… Ø§Ù„Ø­Ø°Ù");
        } catch(e) {
            showToast("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù");
        }
        showLoader(false);
    }

    async function deleteAllCloud() {
        if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ÙƒÙ„ Ø´ÙŠØ¡ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) return;
        showLoader(true);
        try {
            await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            fileId = null;
            localData = [];
            localStorage.removeItem('g_file_id');
            // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯ ÙØ§Ø±Øº ÙÙˆØ±Ø§Ù‹
            await createNewFile();
            renderVault();
            showToast("ØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
            toggleMenu();
        } catch(e) {
            showToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù");
        }
        showLoader(false);
    }

    async function deleteFileApi(id) {
        await fetch(`https://www.googleapis.com/drive/v3/files/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${accessToken}` }
        });
    }

    /* --- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… --- */
    function renderVault() {
        const list = document.getElementById('vaultList');
        list.innerHTML = '';
        if (localData.length === 0) {
            list.innerHTML = '<p style="text-align:center; color:#999">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>';
            return;
        }
        localData.forEach(item => {
            const div = document.createElement('div');
            div.className = 'card';
            div.innerHTML = `
                <div style="flex:1">
                    <div style="font-weight:bold; margin-bottom:5px;">${item.email}</div>
                    <div class="pass-pill" onclick="this.innerText = '${item.pass}'">â€¢â€¢â€¢â€¢â€¢â€¢</div>
                </div>
                <div style="color:var(--danger); padding:10px; cursor:pointer;" onclick="deleteItem(${item.id})">âœ•</div>
            `;
            list.appendChild(div);
        });
    }

    function logout() {
        localStorage.removeItem('g_token');
        localStorage.removeItem('g_file_id');
        location.reload();
    }

    function toggleMenu(e) {
        if(e) e.stopPropagation();
        const m = document.getElementById('mainMenu');
        m.style.display = m.style.display === 'flex' ? 'none' : 'flex';
    }

    function openVault() {
        document.getElementById('vaultPage').style.display = 'flex';
        renderVault();
    }
    
    function closeVault() {
        document.getElementById('vaultPage').style.display = 'none';
    }

    function showLoader(show) {
        document.getElementById('loader').style.display = show ? 'flex' : 'none';
    }
    
    function setStatus(text) {
        document.getElementById('statusText').innerText = text;
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.style.opacity = '1';
        setTimeout(() => t.style.opacity = '0', 3000);
    }

    window.onclick = () => document.getElementById('mainMenu').style.display = 'none';
</script>

</body>
</html>