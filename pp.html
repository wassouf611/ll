<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ø®Ø²Ù†Ø© Ø£Ø³Ø±Ø§Ø±ÙŠ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</title>
    
    <!-- Ù…ÙƒØªØ¨Ø© Ø¬ÙˆØ¬Ù„ -->
    <script src="https://accounts.google.com/gsi/client" onload="initGoogleLib()" async defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #8b5cf6;
            --primary-dark: #7c3aed;
            --bg: #f9fafb;
            --surface: #ffffff;
            --text: #1f2937;
            --danger: #ef4444;
            --success: #10b981;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg);
            margin: 0; padding: 0;
            color: var(--text);
            height: 100vh;
            display: flex; flex-direction: column;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* --- Header --- */
        header {
            height: 60px; padding: 0 20px;
            display: flex; align-items: center; justify-content: space-between;
            background: var(--surface);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            z-index: 100;
        }
        h1 { margin: 0; font-size: 18px; color: var(--primary-dark); font-weight: 700; }
        
        .menu-btn {
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            background: #f3f4f6; cursor: pointer;
        }

        /* --- Main Menu --- */
        .main-menu {
            position: fixed; top: 70px; left: 20px;
            background: white; border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 260px; display: none; flex-direction: column;
            z-index: 1000; border: 1px solid #e5e7eb; overflow: hidden;
        }
        .menu-item {
            padding: 15px; border-bottom: 1px solid #f3f4f6;
            font-size: 14px; font-weight: 500; color: #4b5563;
            display: flex; align-items: center; justify-content: space-between;
            cursor: pointer;
        }
        .menu-item:active { background: #f9fafb; }
        .menu-icon { width: 20px; height: 20px; }
        .sync-item { color: var(--primary); background: #f5f3ff; }
        .delete-item { color: var(--danger); }

        /* --- Inputs --- */
        .container {
            padding: 20px; flex: 1; display: flex; flex-direction: column; gap: 12px;
            max-width: 500px; margin: 0 auto; width: 100%;
        }
        input {
            width: 100%; padding: 16px; border: 1px solid #e5e7eb;
            border-radius: 12px; font-family: 'Tajawal'; font-size: 16px;
            outline: none; background: white;
        }
        input:focus { border-color: var(--primary); }

        .btn {
            width: 100%; padding: 16px; border: none; border-radius: 12px;
            font-size: 16px; font-weight: 700; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3); }
        .btn-outline { background: white; color: var(--primary); border: 2px solid var(--primary); margin-top: 5px; }

        /* --- Vault List --- */
        #vaultPage {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); z-index: 200; display: none;
            flex-direction: column;
        }
        .vault-header-area { padding: 15px 20px; background: white; border-bottom: 1px solid #f3f4f6; }
        .vault-title-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .search-box { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #e5e7eb; background: #f9fafb; font-family: 'Tajawal'; }
        
        .folders-scroll { display: flex; gap: 8px; overflow-x: auto; padding-top: 10px; scrollbar-width: none; }
        .folder-chip { padding: 6px 14px; background: #f3f4f6; border-radius: 20px; font-size: 13px; white-space: nowrap; cursor: pointer; border: 1px solid transparent; }
        .folder-chip.active { background: var(--primary); color: white; }

        #vaultList { flex: 1; overflow-y: auto; padding: 15px; }
        .account-card {
            background: white; padding: 15px; border-radius: 12px;
            margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02); border: 1px solid #f3f4f6;
        }
        .acc-info { display: flex; flex-direction: column; gap: 5px; width: 100%; }
        .acc-email { font-weight: 700; color: #374151; font-size: 15px; }
        .acc-pass { font-family: monospace; color: #6b7280; background: #f9fafb; padding: 5px 10px; border-radius: 6px; width: fit-content; font-size: 16px; cursor: pointer; }
        
        /* --- Toast & Modals --- */
        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: #1f2937; color: white; padding: 12px 24px;
            border-radius: 30px; font-size: 14px; opacity: 0; pointer-events: none;
            transition: 0.3s; z-index: 9999; width: max-content;
        }
        .overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 1500; display: none;
            align-items: center; justify-content: center; backdrop-filter: blur(2px);
        }
        .modal-box {
            background: white; width: 90%; max-width: 320px;
            border-radius: 16px; padding: 20px; text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }
        .modal-btns { display: flex; gap: 10px; margin-top: 20px; }
        .m-btn { flex: 1; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }
        .confirm { background: var(--primary); color: white; }
        .cancel { background: #f3f4f6; color: #374151; }
        
        .folder-list { display: flex; flex-direction: column; gap: 5px; max-height: 200px; overflow-y: auto; margin-top: 10px; }
        .f-item { padding: 12px; background: #f9fafb; border-radius: 8px; cursor: pointer; }
    </style>
</head>
<body>

<header>
    <div class="menu-btn" onclick="toggleMenu(event)">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
    </div>
    <h1>Ø®Ø²Ù†Ø© Ø£Ø³Ø±Ø§Ø±ÙŠ ğŸ”</h1>
    <div style="width: 40px"></div>
</header>

<div id="mainMenu" class="main-menu">
    <div class="menu-item" id="googleItem" onclick="handleGoogle()">
        <span id="googleText">Ø±Ø¨Ø· Ø¬ÙˆØ¬Ù„ Ø¯Ø±Ø§ÙŠÙ</span>
        <span id="googleIcon">â˜ï¸</span>
    </div>
    <div class="menu-item sync-item" onclick="smartSync()">
        <span>ğŸ”„ Ù…Ø²Ø§Ù…Ù†Ø© ÙˆØ¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
    </div>
    <div class="menu-item" onclick="exportData()">
        <span>Ù†Ø³Ø® ÙƒÙˆØ¯ Ø§Ø­ØªÙŠØ§Ø·ÙŠ</span>
        <span>ğŸ“‹</span>
    </div>
    <div class="menu-item" onclick="importData()">
        <span>Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙƒÙˆØ¯</span>
        <span>ğŸ“¥</span>
    </div>
    <div class="menu-item delete-item" onclick="deleteAll()">
        <span>Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
        <span>ğŸ—‘ï¸</span>
    </div>
</div>

<!-- Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
<div class="container">
    <div style="text-align:center; color:#6b7280; font-size:12px; margin-bottom:10px" id="statusMsg">Ø§Ù„ÙˆØ¶Ø¹: Ù…Ø­Ù„ÙŠ</div>
    
    <input type="text" id="emailIn" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† / Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„">
    <input type="text" id="passIn" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± / Ø§Ù„Ø³Ø±">
    
    <button class="btn btn-primary" onclick="preSave()">
        <span>Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø®Ø²Ù†Ø©</span>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline></svg>
    </button>
    
    <button class="btn btn-outline" onclick="openVault()">
        <span>ÙØªØ­ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø§Øª</span>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
    </button>
</div>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø®Ø²Ù†Ø© -->
<div id="vaultPage">
    <div class="vault-header-area">
        <div class="vault-title-row">
            <h2 style="margin:0; font-size:18px">Ù…Ù„ÙØ§ØªÙŠ</h2>
            <div class="menu-btn" onclick="closeVault()">âœ•</div>
        </div>
        <input type="text" class="search-box" id="searchIn" placeholder="Ø¨Ø­Ø«..." oninput="renderVault()">
        <div class="folders-scroll" id="folderBar"></div>
    </div>
    <div id="vaultList"></div>
</div>

<!-- Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© -->
<div id="folderModal" class="overlay">
    <div class="modal-box">
        <h3>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¬Ù„Ø¯</h3>
        <div class="folder-list" id="folderListDiv"></div>
        <div class="modal-btns">
            <button class="m-btn cancel" onclick="closeModal('folderModal')">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<div id="confirmModal" class="overlay">
    <div class="modal-box">
        <h3>ØªÙ†Ø¨ÙŠÙ‡</h3>
        <p id="confirmMsg"></p>
        <div class="modal-btns">
            <button class="m-btn cancel" onclick="closeModal('confirmModal')">Ù„Ø§</button>
            <button class="m-btn confirm" id="confirmBtnAction">Ù†Ø¹Ù…</button>
        </div>
    </div>
</div>

<div id="backupModal" class="overlay">
    <div class="modal-box">
        <h3>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</h3>
        <textarea id="backupArea" style="width:100%; height:100px; border:1px solid #ddd; border-radius:8px"></textarea>
        <div class="modal-btns">
            <button class="m-btn confirm" onclick="copyText()">Ù†Ø³Ø®</button>
            <button class="m-btn cancel" onclick="closeModal('backupModal')">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>
</div>

<div id="toast" class="toast">ØªÙ…</div>

<script>
    // --- Data & Init ---
    let accounts = JSON.parse(localStorage.getItem('myAccs') || '[]');
    let folders = JSON.parse(localStorage.getItem('myFolders') || '["Ø¹Ø§Ù…", "Ø³ÙˆØ´ÙŠØ§Ù„", "Ø¹Ù…Ù„"]');
    let activeFolder = 'All';
    
    // --- Google Config ---
    const CLIENT_ID = '979816526016-ukb9vqtb6u2hlutombpf8rumbjr3o2ua.apps.googleusercontent.com';
    const SCOPE = 'https://www.googleapis.com/auth/drive.appdata';
    let tokenClient, gToken = localStorage.getItem('gToken');
    
    function initGoogleLib() {
        if(window.google) {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID, scope: SCOPE,
                callback: (resp) => {
                    if(resp.access_token) {
                        gToken = resp.access_token;
                        localStorage.setItem('gToken', gToken);
                        updateUI(true);
                        showToast("ØªÙ… Ø§Ù„Ø±Ø¨Ø· Ø¨Ù†Ø¬Ø§Ø­ âœ…");
                        smartSync(); // Auto sync on login
                    }
                }
            });
            if(gToken) updateUI(true);
        }
    }

    function updateUI(isLogged) {
        const txt = document.getElementById('googleText');
        const st = document.getElementById('statusMsg');
        if(isLogged) {
            txt.innerText = "ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬";
            txt.style.color = "red";
            st.innerText = "Ø§Ù„ÙˆØ¶Ø¹: Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø³Ø­Ø§Ø¨Ø© â˜ï¸";
            st.style.color = "green";
        } else {
            txt.innerText = "Ø±Ø¨Ø· Ø¬ÙˆØ¬Ù„ Ø¯Ø±Ø§ÙŠÙ";
            txt.style.color = "#4b5563";
            st.innerText = "Ø§Ù„ÙˆØ¶Ø¹: Ù…Ø­Ù„ÙŠ ÙÙ‚Ø· ğŸ ";
            st.style.color = "gray";
        }
    }

    function handleGoogle() {
        document.getElementById('mainMenu').style.display = 'none';
        if(gToken) {
            // Logout
            if(confirm("ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø¬ÙˆØ¬Ù„ØŸ")) {
                const token = gToken;
                google.accounts.oauth2.revoke(token, done => {});
                localStorage.removeItem('gToken');
                gToken = null;
                updateUI(false);
                showToast("ØªÙ… Ø§Ù„Ø®Ø±ÙˆØ¬");
            }
        } else {
            // Login
            tokenClient.requestAccessToken();
        }
    }

    // --- Core Logic: SMART SYNC ---
    async function smartSync() {
        document.getElementById('mainMenu').style.display = 'none';
        if(!gToken) return showToast("ÙŠØ¬Ø¨ Ø±Ø¨Ø· Ø¬ÙˆØ¬Ù„ Ø£ÙˆÙ„Ø§Ù‹ âš ï¸");
        
        showToast("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³Ø­Ø§Ø¨Ø©... â³");
        
        try {
            // 1. Search for files
            const q = "name='khazna_db_v2.json' and 'appDataFolder' in parents and trashed=false";
            const res = await fetch(`https://www.googleapis.com/drive/v3/files?q=${q}&spaces=appDataFolder`, {
                headers: { 'Authorization': `Bearer ${gToken}` }
            });
            const data = await res.json();
            
            let cloudAccounts = [];
            let cloudFolders = [];
            let fileId = null;

            if(data.files && data.files.length > 0) {
                // Found file(s), download the first one
                fileId = data.files[0].id;
                const contentRes = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                    headers: { 'Authorization': `Bearer ${gToken}` }
                });
                const content = await contentRes.json();
                if(content.accounts) cloudAccounts = content.accounts;
                if(content.folders) cloudFolders = content.folders;

                // ** Cleanup Duplicates ** if google created multiple files
                if(data.files.length > 1) {
                    for(let i=1; i<data.files.length; i++) {
                        await fetch(`https://www.googleapis.com/drive/v3/files/${data.files[i].id}`, {
                            method: 'DELETE', headers: { 'Authorization': `Bearer ${gToken}` }
                        });
                    }
                }
            }

            // 2. MERGE LOGIC (The Magic)
            // Combine Local and Cloud based on unique ID
            const combinedMap = new Map();
            
            // Add cloud items first
            cloudAccounts.forEach(acc => combinedMap.set(acc.id, acc));
            // Add/Overwrite with local items (assuming local might have edits, or vice versa)
            // To be safe: we keep both if IDs differ. If IDs same, we assume they are same.
            accounts.forEach(acc => combinedMap.set(acc.id, acc));

            // Merge Folders
            const mergedFolders = [...new Set([...folders, ...cloudFolders])];

            // Update State
            accounts = Array.from(combinedMap.values());
            folders = mergedFolders;
            
            // Sort by newest
            accounts.sort((a,b) => b.id - a.id);

            // Save Local
            localStorage.setItem('myAccs', JSON.stringify(accounts));
            localStorage.setItem('myFolders', JSON.stringify(folders));

            // 3. Upload merged version back to cloud (Overwrite old file)
            const fileData = JSON.stringify({ accounts, folders });
            const file = new Blob([fileData], { type: 'application/json' });
            const metadata = { name: 'khazna_db_v2.json', mimeType: 'application/json', parents: ['appDataFolder'] };
            
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', file);

            if(fileId) {
                // Update existing
                await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart`, {
                    method: 'PATCH', headers: { 'Authorization': `Bearer ${gToken}` }, body: form
                });
            } else {
                // Create new
                await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST', headers: { 'Authorization': `Bearer ${gToken}` }, body: form
                });
            }

            showToast(`ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: ${accounts.length} Ø¹Ù†ØµØ± âœ…`);
            renderVault();

        } catch(err) {
            console.error(err);
            if(err.status === 401) {
                localStorage.removeItem('gToken'); gToken=null; updateUI(false);
                showToast("Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø©ØŒ Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹");
            } else {
                showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ© âŒ");
            }
        }
    }

    // --- App Logic ---
    function toggleMenu(e) {
        e.stopPropagation();
        const m = document.getElementById('mainMenu');
        m.style.display = m.style.display === 'flex' ? 'none' : 'flex';
    }
    window.onclick = () => document.getElementById('mainMenu').style.display = 'none';

    function preSave() {
        const e = document.getElementById('emailIn').value;
        const p = document.getElementById('passIn').value;
        if(!e || !p) return showToast("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        
        // Show folder selection
        const list = document.getElementById('folderListDiv');
        list.innerHTML = `<div class="f-item" style="color:var(--primary);font-weight:bold" onclick="addNewFolder()">+ Ù…Ø¬Ù„Ø¯ Ø¬Ø¯ÙŠØ¯</div>`;
        folders.forEach(f => {
            list.innerHTML += `<div class="f-item" onclick="saveTo('${f}')">${f}</div>`;
        });
        document.getElementById('folderModal').style.display = 'flex';
    }

    function addNewFolder() {
        const n = prompt("Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù„Ø¯:");
        if(n && !folders.includes(n)) {
            folders.push(n);
            localStorage.setItem('myFolders', JSON.stringify(folders));
            saveTo(n);
        }
    }

    function saveTo(folder) {
        const email = document.getElementById('emailIn').value;
        const pass = document.getElementById('passIn').value;
        const newAcc = { id: Date.now(), email, pass, folder };
        
        accounts.unshift(newAcc); // Add to top
        localStorage.setItem('myAccs', JSON.stringify(accounts));
        
        document.getElementById('emailIn').value = '';
        document.getElementById('passIn').value = '';
        document.getElementById('folderModal').style.display = 'none';
        
        showToast("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ âœ…");
        // Auto Upload if logged in
        if(gToken) smartSync();
    }

    function openVault() {
        renderFoldersBar();
        renderVault();
        document.getElementById('vaultPage').style.display = 'flex';
    }
    function closeVault() {
        document.getElementById('vaultPage').style.display = 'none';
    }

    function renderFoldersBar() {
        const d = document.getElementById('folderBar');
        d.innerHTML = `<div class="folder-chip ${activeFolder==='All'?'active':''}" onclick="setFolder('All')">Ø§Ù„ÙƒÙ„</div>`;
        folders.forEach(f => {
            d.innerHTML += `<div class="folder-chip ${activeFolder===f?'active':''}" onclick="setFolder('${f}')">${f}</div>`;
        });
    }

    function setFolder(f) {
        activeFolder = f;
        renderFoldersBar();
        renderVault();
    }

    function renderVault() {
        const list = document.getElementById('vaultList');
        const search = document.getElementById('searchIn').value.toLowerCase();
        list.innerHTML = '';
        
        let filtered = accounts;
        if(activeFolder !== 'All') filtered = filtered.filter(a => a.folder === activeFolder);
        if(search) filtered = filtered.filter(a => a.email.toLowerCase().includes(search) || a.folder.toLowerCase().includes(search));

        if(filtered.length === 0) list.innerHTML = '<div style="text-align:center;margin-top:20px;color:#aaa">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>';

        filtered.forEach(acc => {
            const div = document.createElement('div');
            div.className = 'account-card';
            div.innerHTML = `
                <div class="acc-info">
                    <div style="font-size:12px;color:#9ca3af">${acc.folder}</div>
                    <div class="acc-email">${acc.email}</div>
                    <div class="acc-pass" onclick="togglePass(this, '${acc.pass}')">â€¢â€¢â€¢â€¢â€¢â€¢</div>
                </div>
                <div style="color:var(--danger);font-size:20px;cursor:pointer;padding:10px" onclick="deleteAcc(${acc.id})">Ã—</div>
            `;
            list.appendChild(div);
        });
    }

    function togglePass(el, realPass) {
        if(el.innerText.includes('â€¢')) {
            el.innerText = realPass;
            el.style.color = 'var(--primary)';
        } else {
            el.innerText = 'â€¢â€¢â€¢â€¢â€¢â€¢';
            el.style.color = '#6b7280';
        }
    }

    function deleteAcc(id) {
        if(confirm("Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ØŸ")) {
            accounts = accounts.filter(a => a.id !== id);
            localStorage.setItem('myAccs', JSON.stringify(accounts));
            renderVault();
            if(gToken) smartSync();
        }
    }

    function deleteAll() {
        document.getElementById('mainMenu').style.display = 'none';
        if(confirm("ØªØ­Ø°ÙŠØ±! Ø³ÙŠØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø´ÙŠØ¡ Ù…Ù† Ø§Ù„Ø¬ÙˆØ§Ù„ ÙˆÙ…Ù† Ø¬ÙˆØ¬Ù„ Ø¯Ø±Ø§ÙŠÙ. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) {
            localStorage.clear();
            accounts = [];
            folders = ["Ø¹Ø§Ù…"];
            updateUI(false);
            if(gToken) {
                // Upload empty
                smartSync();
            }
            showToast("ØªÙ… ÙØ±Ù…ØªØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ğŸ—‘ï¸");
            setTimeout(() => location.reload(), 1000);
        }
    }

    // --- Import/Export ---
    function exportData() {
        document.getElementById('mainMenu').style.display = 'none';
        const json = JSON.stringify({accounts, folders});
        document.getElementById('backupArea').value = json;
        document.getElementById('backupModal').style.display = 'flex';
    }
    function copyText() {
        const t = document.getElementById('backupArea');
        t.select(); document.execCommand('copy');
        showToast("ØªÙ… Ø§Ù„Ù†Ø³Ø®");
        closeModal('backupModal');
    }
    function importData() {
        document.getElementById('mainMenu').style.display = 'none';
        const code = prompt("Ø§Ù„ØµÙ‚ Ø§Ù„ÙƒÙˆØ¯ Ù‡Ù†Ø§:");
        try {
            const d = JSON.parse(code);
            if(d.accounts && d.folders) {
                accounts = d.accounts;
                folders = d.folders;
                localStorage.setItem('myAccs', JSON.stringify(accounts));
                localStorage.setItem('myFolders', JSON.stringify(folders));
                showToast("ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­");
                if(gToken) smartSync();
            }
        } catch(e) { showToast("ÙƒÙˆØ¯ Ø®Ø§Ø·Ø¦"); }
    }

    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.style.opacity = 1;
        setTimeout(() => t.style.opacity = 0, 3000);
    }
</script>

</body>
</html>